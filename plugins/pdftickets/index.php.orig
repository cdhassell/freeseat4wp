<?php

define('FS_PATH', '../../');
require_once(FS_PATH . "vars.php");
require_once(FS_PATH . 'functions/format.php');
require_once(FS_PATH . 'functions/money.php');
require_once(FS_PATH . 'functions/mysql.php');
require_once(FS_PATH . 'functions/plugins.php');
require_once(FS_PATH . 'functions/shows.php');
require_once(FS_PATH . 'functions/session.php');
require_once(FS_PATH . 'functions/spectacle.php');
require_once(FS_PATH . 'functions/tools.php');

// this code is called to download a PDF file to the user

ensure_plugin('pdftickets');

db_connect();

if (!isset($_GET["key"])) {
  /* This typically happens if the user opens the plugin directory in
   his browser. */
  fatal_error('This page is not meant to be accessed directly');
 }

$key = (int)($_GET["key"]);

if (!(isset($_SESSION["pdftickets"]) && isset($_SESSION["pdftickets"][$key]))) {
  /* This typically happens if the user's session expired and he tried
   to load his tickets once more. Should maybe let the remail plugin
   put a message that the user may retrieve his tickets through the
   frontpage remail link.. */
  fatal_error('Sorry, your ticket reference expired.');
 }

$allbookings = $_SESSION["pdftickets"][$key];

/*  We get here if this is the first ticket to be output.
 *  For PDF output we need to accumulate all of the html into one variable 
 *  and then call $dompdf->render(). This code stores the page in a global 
 *  variable $pdf_ticket as it is developed.
 *  Dompdf wants to get a complete page, including the <html>,<head> and
 *  <body> tags, so we can't rely on any functions like show_head(), 
 *  show_foot(), show_show_info(), etc. which echo to the screen.
 *  Dompdf supports only a subset of CSS2, so we have to be careful about 
 *  our markup.  For example, it does not handle floats well.  This code 
 *  expects to copy a file called ticket.css into the ticket page.  
 *  Also, be aware that dompdf can't handle .png images, so stick to jpeg.
 */
$sp = $allbookings[0]["spectacleid"];
$cls = $allbookings[0]["class"];
$prices = get_spec_prices( $sp );
// $desc = m_eval("select description from class_comment where spectacle=$sp and class=$cls");
$s = get_spectacle($sp);
if ($s['imagesrc']) {
  $logo = apply_fspath($upload_url . $s['imagesrc']);
 } else {
  $logo = apply_fspath($ticket_logo);
 }
      
// ticket output starts
$html = "<html><head><style>";
$html .= file_get_contents(FS_PATH . "plugins/pdftickets/ticket.css", FILE_USE_INCLUDE_PATH);
$html .= "</style></head><body>";
$html .= "<div class='wide'><p class='highlight'>".$lang["intro_finish"]."</p>";
$html .= "<div class='ticket2'>";
$html .= "<table><tr><td><div class='title'>";
$html .= "<p class='temph'>" . $s['name'] . "</p></div>";
$html .= "<p>".show_info(get_show($allbookings[0]["showid"]),false)."</p>";
$html .= "<td><div class='title'><img alt='Logo' src='$logo'></div></td>";
$html .= "<td>";
$html .= do_hook_concat('booking_return',$allbookings[0]);
$html .= "</td></tr></table>";
$html .= "<p class='main'><b>".$lang["name"].": </b>".$allbookings[0]["firstname"]." ".$allbookings[0]["lastname"]."</p>";
if (get_total() > 0) {
  $html .= "<p class='main'><b>".$lang["payment"].": </b>".f_payment($_SESSION["payment"])."</p>";
}
$html .= "<p class='main'>";
$html .= print_booked_seats($allbookings,FMT_SHOWID|FMT_PRICE|FMT_HTML|FMT_NOCOUNT);
  $html .= "</p><p class='main'><b>".$lang["mail-thankee"]."</b></p>";
  $html .= "<p class='main'>";
  foreach ($legal_info as $n => $line)
    $html .= $line . "<br>";
  $html .= "</p></div></body></html>";	
/* Now convert $html to $pdf */

  $dompdf = new DOMPDF();
  $dompdf->load_html($html);
  $dompdf->render();
  $pdf = $dompdf->output();

    // fix for IE catching or PHP bug issue
    header("Pragma: public");
    // set expiration time
    header("Expires: 0");
    header("Content-Type: application/pdf");
    header("Content-Type: application/download");
    header('Content-Disposition: attachment; filename=mytickets.pdf');
echo $pdf;
  ?>
